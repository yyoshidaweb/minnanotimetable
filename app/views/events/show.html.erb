<%# タイムテーブル表示画面のメインコンテナ %>
<div class="h-[calc(100vh-3rem)] flex flex-col overflow-hidden">
  <%# 日付選択タブ %>
  <nav class="flex justify-around overflow-x-auto bg-white border-t border-gray-200">
    <% @event.days.each do |day| %>
      <%# 日付を MM/DD 形式でラベルに整形 %>
      <% label = day.date.strftime("%-m/%-d") %>
      <%# 現在選択中の日付かどうか判定 %>
      <% selected = (day.date == @selected_date) %>
      <%# 日付タブリンク。選択中の場合は下線を表示し、横幅は均等に伸ばす %>
      <%= link_to event_path(@event.event_key, d: day.date),
                  class: "flex-1 px-2 py-2 text-xs text-gray-800 font-bold border-b-4 #{selected ? 'border-gray-800' : 'border-transparent'} hover:border-gray-300 transition-colors duration-150 text-center whitespace-nowrap" do %>
        <%= label %>
      <% end %>
    <% end %>
  </nav>
  <%# タイムテーブル表示エリア - スクロール可能 %>
  <div class="flex-1 min-h-0 bg-white overflow-auto w-full">
    <table class="w-full relative bg-white rounded-lg shadow-sm">
      <%# テーブルヘッダー - ステージ名 %>
      <thead class="h-8 bg-white">
        <tr>
          <%# 左端の時刻列用の空セル %>
          <th class="w-[1.5rem] pl-1.5 pr-1 py-1 text-left text-xs font-medium text-gray-500 tracking-wider sticky left-0 top-0 z-[110] bg-gray-50">
            <div class="absolute inset-0 bg-white z-[110]"></div>
            <div class="absolute right-0 bottom-[-1px] h-[1px] w-full bg-white z-[110]"></div>
            <span class="relative z-[110]"></span>
          </th>
          <%# Event に紐づくステージを StageNameTag.name で取得してアルファベット順にソート %>
          <% stages = @event.stages.includes(:stage_name_tag).sort_by { |s| s.stage_name_tag.name } %>
          <% stages.each_with_index do |stage, stage_index| %>
            <%# ステージ名列 %>
            <th class="w-[calc((100%-2rem)/<%= stages.length %>)] p-1 h-8 text-center text-xs font-bold text-gray-800 tracking-wider sticky top-0 z-[100] relative <%= stage_index != stages.length-1 ? 'border-r border-white' : '' %>">
              <div class="absolute inset-0 <%= stage_index.odd? ? 'bg-gray-200' : 'bg-gray-300' %> z-[95]">
              </div>
              <%# ステージ名 %>
              <div class="relative z-[100] flex items-center justify-center">
                <p class="leading-tight text-center wrap-break-word line-clamp-2">
                  <%= stage.stage_name_tag.name %>
                </p>
              </div>
            </th>
          <% end %>
        </tr>
      </thead>
      <%# タイムテーブル本体 %>
      <tbody>
        <%# 開始時刻が最も早い出演者の出演時刻を取得 %>
        <% earliest_time = @event.performances.minimum(:start_time)&.hour %>
        <%# 終了時刻が最も遅い出演者の出演時刻を取得 %>
        <% latest_end_time = @event.performances.maximum(:end_time)&.hour %>
        <%# 最も早い開始時刻から最も遅い終了時間までのタイムテーブルを描画する %>
        <% (earliest_time..latest_end_time).each do |hour| %>
          <% (0..55).step(5) do |minute| %>
            <tr class="h-4 relative">
              <%# 時刻列 - 左側に固定表示 %>
              <td class="min-w-[1.25rem] px-0 h-4 bg-white sticky left-0 z-[150]">
                <div class="absolute inset-0 bg-white z-[145]"></div>
                <div class="absolute inset-0 flex items-center justify-center z-[150]">
                  <div class="w-full h-full flex items-center justify-center -translate-y-[6px]">
                    <%# 正時のみ時刻を表示 %>
                    <% if minute == 0 %>
                      <span class="text-xs font-medium text-gray-900 tabular-nums">
                        <%= format("%02d", hour) %>
                      </span>
                    <% end %>
                  </div>
                </div>
              </td>
              <%# 各ステージの時間枠 %>
              <% stages.each_with_index do |stage, stage_index| %>
                <%# ステージの時間枠と、縦の区切り線の表示 %>
                <td class="w-[calc((100%-2rem)/<%= stages.length %>)] min-w-[80px] max-w-[120px] relative <%= stage_index.odd? ? 'bg-gray-100' : 'bg-gray-200' %> <%= stage_index != stages.length-1 ? 'border-r border-white' : '' %>">
                  <%# 横の区切り線の表示 %>
                  <% if minute == 0 || minute == 30 %>
                    <div class=" absolute inset-x-0 top-0 border-t border-white z-[5]">
                    </div>
                  <% end %>
                  <%# ステージごとの出演者を取得 %>
                  <% stage_performances = @event.performances.where(stage: stage) %>
                  <%# 出演情報カードの表示 %>
                  <% stage_performances.each do |performance| %>
                    <%# 出演開始時刻%>
                    <% start_h = performance.start_time.hour %>
                    <%# 出演終了時刻 %>
                    <% start_m = performance.start_time.min %>
                    <% if start_h == hour && start_m == minute %>
                      <%# 出演情報カードのリンク（リンク先は仮の値） %>
                      <%= link_to "#", class: "block absolute inset-x-[1px] top-0 z-[10] hover:scale-[1.02] transition-transform duration-150", style: "height: #{duration_to_rows(performance.duration)}rem" do %>
                        <%# 出演情報カードの内容 %>
                        <div class="bg-white rounded-lg p-1 w-full h-full shadow-sm hover:shadow transition-shadow duration-150">
                          <%# 時間表示 %>
                          <div class="text-xs font-light leading-xs line-clamp-1 text-gray-800">
                            <%= format("%02d:%02d", hour, minute) %>
                          </div>
                          <%# 出演者名 - 公演時間に応じて行数制限 %>
                          <% line_clamp = if performance.duration <= 15
                                        'line-clamp-1'
                                    elsif performance.duration <= 30
                                        'line-clamp-4'
                                    else
                                        'line-clamp-6'
                                    end
                                %>
                          <div class="font-semibold text-xs leading-xs text-gray-800 <%= line_clamp %>">
                            <%= performance.performer.performer_name_tag.name %>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </td>
              <% end %>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>